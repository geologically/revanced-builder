name: Build on Patch Update

on:
  schedule:
    - cron: "20 */4 * * *"  # Every 4 hours
  workflow_dispatch:

jobs:
  check-patch:
    permissions: write-all
    runs-on: ubuntu-latest
    outputs:
      trigger_stable: ${{ steps.compare.outputs.TRIGGER_STABLE }}
      trigger_prerelease: ${{ steps.compare.outputs.TRIGGER_PRERELEASE }}
      sa_old: ${{ steps.compare.outputs.sa_old }}
      sa_new: ${{ steps.compare.outputs.sa_new }}
      so_old: ${{ steps.compare.outputs.so_old }}
      so_new: ${{ steps.compare.outputs.so_new }}
      se_old: ${{ steps.compare.outputs.se_old }}
      se_new: ${{ steps.compare.outputs.se_new }}
      pa_old: ${{ steps.compare.outputs.pa_old }}
      pa_new: ${{ steps.compare.outputs.pa_new }}
      po_old: ${{ steps.compare.outputs.po_old }}
      po_new: ${{ steps.compare.outputs.po_new }}
      pe_old: ${{ steps.compare.outputs.pe_old }}
      pe_new: ${{ steps.compare.outputs.pe_new }}
      stable_config: ${{ steps.generate_configs.outputs.stable_config }}
      dev_config: ${{ steps.generate_configs.outputs.dev_config }}
      next_stable_ver: ${{ steps.versions.outputs.next_stable_ver }}
      next_dev_ver: ${{ steps.versions.outputs.next_dev_ver }}
    steps:
      - name: Checkout (Main)
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          submodules: true

      - name: Create .github/misc directory
        run: mkdir -p .github/misc

      - name: Fetch Latest Tags (Stable and Dev)
        id: fetch_tags
        run: |
          get_latest_tag() {
            local repo=$1
            local prerelease=$2
            curl -s "https://api.github.com/repos/$repo/releases" \
              | jq -r "
                map(select(.prerelease == $prerelease and .tag_name != null and .tag_name != \"\")) |
                sort_by(.published_at) |
                reverse |
                .[0].tag_name // \"\"
              "
          }
          echo "stable_advanced=$(get_latest_tag anddea/revanced-patches false)" >> "$GITHUB_OUTPUT"
          echo "prerelease_advanced=$(get_latest_tag anddea/revanced-patches true)" >> "$GITHUB_OUTPUT"
          echo "stable_official=$(get_latest_tag revanced/revanced-patches false)" >> "$GITHUB_OUTPUT"
          echo "prerelease_official=$(get_latest_tag revanced/revanced-patches true)" >> "$GITHUB_OUTPUT"
          echo "stable_extended=$(get_latest_tag inotia00/revanced-patches false)" >> "$GITHUB_OUTPUT"
          echo "prerelease_extended=$(get_latest_tag inotia00/revanced-patches true)" >> "$GITHUB_OUTPUT"

      - name: Initialize Tag Tracking File if Missing
        id: init_tags
        run: |
          if [ ! -f .github/misc/last_tags.json ]; then
            jq -n \
              --arg sa "${{ steps.fetch_tags.outputs.stable_advanced }}" \
              --arg pa "${{ steps.fetch_tags.outputs.prerelease_advanced }}" \
              --arg so "${{ steps.fetch_tags.outputs.stable_official }}" \
              --arg po "${{ steps.fetch_tags.outputs.prerelease_official }}" \
              --arg se "${{ steps.fetch_tags.outputs.stable_extended }}" \
              --arg pe "${{ steps.fetch_tags.outputs.prerelease_extended }}" \
              '{
                advanced: { stable: ($sa | select(length > 0)), prerelease: ($pa | select(length > 0)) },
                official: { stable: ($so | select(length > 0)), prerelease: ($po | select(length > 0)) },
                extended: { stable: ($se | select(length > 0)), prerelease: ($pe | select(length > 0)) }
              }' > .github/misc/last_tags.json
            echo "missing=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Initialized Tag File
        if: steps.init_tags.outputs.missing == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/last_tags.json
          commit_message: "Initialize tag tracking JSON in .github/misc"

      - name: Compare Latest vs Stored Tags
        id: compare
        run: |
          SA_OLD=$(jq -r '.advanced.stable // ""' .github/misc/last_tags.json)
          PA_OLD=$(jq -r '.advanced.prerelease // ""' .github/misc/last_tags.json)
          SO_OLD=$(jq -r '.official.stable // ""' .github/misc/last_tags.json)
          PO_OLD=$(jq -r '.official.prerelease // ""' .github/misc/last_tags.json)
          SE_OLD=$(jq -r '.extended.stable // ""' .github/misc/last_tags.json)
          PE_OLD=$(jq -r '.extended.prerelease // ""' .github/misc/last_tags.json)

          SA_NEW="${{ steps.fetch_tags.outputs.stable_advanced }}"
          PA_NEW="${{ steps.fetch_tags.outputs.prerelease_advanced }}"
          SO_NEW="${{ steps.fetch_tags.outputs.stable_official }}"
          PO_NEW="${{ steps.fetch_tags.outputs.prerelease_official }}"
          SE_NEW="${{ steps.fetch_tags.outputs.stable_extended }}"
          PE_NEW="${{ steps.fetch_tags.outputs.prerelease_extended }}"

          TRIGGER_STABLE=0
          TRIGGER_PRERELEASE=0

          [ -n "$SA_NEW" ] && [ "$SA_NEW" != "$SA_OLD" ] && TRIGGER_STABLE=1
          [ -n "$SO_NEW" ] && [ "$SO_NEW" != "$SO_OLD" ] && TRIGGER_STABLE=1
          [ -n "$SE_NEW" ] && [ "$SE_NEW" != "$SE_OLD" ] && TRIGGER_STABLE=1

          [ -n "$PA_NEW" ] && [ "$PA_NEW" != "$PA_OLD" ] && TRIGGER_PRERELEASE=1
          [ -n "$PO_NEW" ] && [ "$PO_NEW" != "$PO_OLD" ] && TRIGGER_PRERELEASE=1
          [ -n "$PE_NEW" ] && [ "$PE_NEW" != "$PE_OLD" ] && TRIGGER_PRERELEASE=1

          jq -n \
            --arg sa "$SA_NEW" --arg pa "$PA_NEW" \
            --arg so "$SO_NEW" --arg po "$PO_NEW" \
            --arg se "$SE_NEW" --arg pe "$PE_NEW" \
            '{
              advanced: { stable: ($sa | select(length > 0)), prerelease: ($pa | select(length > 0)) },
              official: { stable: ($so | select(length > 0)), prerelease: ($po | select(length > 0)) },
              extended: { stable: ($se | select(length > 0)), prerelease: ($pe | select(length > 0)) }
            }' > .github/misc/last_tags.json

          echo "TRIGGER_STABLE=$TRIGGER_STABLE" >> "$GITHUB_OUTPUT"
          echo "TRIGGER_PRERELEASE=$TRIGGER_PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "sa_old=$SA_OLD" >> "$GITHUB_OUTPUT"
          echo "sa_new=$SA_NEW" >> "$GITHUB_OUTPUT"
          echo "so_old=$SO_OLD" >> "$GITHUB_OUTPUT"
          echo "so_new=$SO_NEW" >> "$GITHUB_OUTPUT"
          echo "se_old=$SE_OLD" >> "$GITHUB_OUTPUT"
          echo "se_new=$SE_NEW" >> "$GITHUB_OUTPUT"
          echo "pa_old=$PA_OLD" >> "$GITHUB_OUTPUT"
          echo "pa_new=$PA_NEW" >> "$GITHUB_OUTPUT"
          echo "po_old=$PO_OLD" >> "$GITHUB_OUTPUT"
          echo "po_new=$PO_NEW" >> "$GITHUB_OUTPUT"
          echo "pe_old=$PE_OLD" >> "$GITHUB_OUTPUT"
          echo "pe_new=$PE_NEW" >> "$GITHUB_OUTPUT"

      - name: Commit Updated Tag JSON
        if: steps.compare.outputs.TRIGGER_STABLE == '1' || steps.compare.outputs.TRIGGER_PRERELEASE == '1'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/last_tags.json
          commit_message: "Update last_tags.json with latest patch versions"

      - name: Generate Configs (Stable and Dev)
        id: generate_configs
        if: steps.compare.outputs.TRIGGER_STABLE == '1' || steps.compare.outputs.TRIGGER_PRERELEASE == '1'
        run: |
          OLD_ADVANCED_S="${{ steps.compare.outputs.sa_old }}"
          NEW_ADVANCED_S="${{ steps.compare.outputs.sa_new }}"
          OLD_OFFICIAL_S="${{ steps.compare.outputs.so_old }}"
          NEW_OFFICIAL_S="${{ steps.compare.outputs.so_new }}"
          OLD_EXTENDED_S="${{ steps.compare.outputs.se_old }}"
          NEW_EXTENDED_S="${{ steps.compare.outputs.se_new }}"

          OLD_ADVANCED_D="${{ steps.compare.outputs.pa_old }}"
          NEW_ADVANCED_D="${{ steps.compare.outputs.pa_new }}"
          OLD_OFFICIAL_D="${{ steps.compare.outputs.po_old }}"
          NEW_OFFICIAL_D="${{ steps.compare.outputs.po_new }}"
          OLD_EXTENDED_D="${{ steps.compare.outputs.pe_old }}"
          NEW_EXTENDED_D="${{ steps.compare.outputs.pe_new }}"

          BASE_CONFIG="config.toml"

          generate_config() {
            local mode="$1"
            local out_file=".github/misc/config.$mode.updated.toml"
            cp "$BASE_CONFIG" "$out_file"

            if [ "$mode" = "dev" ]; then
              echo 'patches-version = "dev"' > tmp_header
              cat "$out_file" >> tmp_header
              mv tmp_header "$out_file"
            fi

            local old_a new_a old_o new_o old_e new_e
            if [ "$mode" = "stable" ]; then
              old_a="$OLD_ADVANCED_S"; new_a="$NEW_ADVANCED_S"
              old_o="$OLD_OFFICIAL_S"; new_o="$NEW_OFFICIAL_S"
              old_e="$OLD_EXTENDED_S"; new_e="$NEW_EXTENDED_S"
            else
              old_a="$OLD_ADVANCED_D"; new_a="$NEW_ADVANCED_D"
              old_o="$OLD_OFFICIAL_D"; new_o="$NEW_OFFICIAL_D"
              old_e="$OLD_EXTENDED_D"; new_e="$NEW_EXTENDED_D"
            fi

            awk -v old_advanced="$old_a" -v new_advanced="$new_a" \
                -v old_official="$old_o" -v new_official="$new_o" \
                -v old_extended="$old_e" -v new_extended="$new_e" '
            BEGIN {
                section = ""
                keep = 1
            }
            /^\[.*\]/ {
                flush_section()
                section = $0
                delete lines
                lines[0] = $0
                n = 1
                keep = 1
                next
            }
            {
                lines[n++] = $0
                if ($0 ~ /patches-source *= *"[^"]+"/) {
                    match($0, /patches-source *= *"([^"]+)"/, m)
                    src = m[1]
                    if (src == "anddea/revanced-patches" && (new_advanced == "" || new_advanced == old_advanced)) {
                        keep = 0
                    } else if (src == "revanced/revanced-patches" && (new_official == "" || new_official == old_official)) {
                        keep = 0
                    } else if (src == "inotia00/revanced-patches" && (new_extended == "" || new_extended == old_extended)) {
                        keep = 0
                    }
                }
            }
            END {
                flush_section()
            }
            function flush_section() {
                if (length(lines) == 0) return
                for (i = 0; i < length(lines); i++) {
                    line = lines[i]
                    if (!keep) {
                        gsub(/enabled *= *true/, "enabled = false", line)
                    }
                    print line
                }
            }
            ' "$out_file" > tmp && mv tmp "$out_file"

            echo "${mode}_config=${out_file}" >> "$GITHUB_OUTPUT"
          }

          if [ "${{ steps.compare.outputs.TRIGGER_STABLE }}" = "1" ]; then
            generate_config "stable"
          fi
          if [ "${{ steps.compare.outputs.TRIGGER_PRERELEASE }}" = "1" ]; then
            generate_config "dev"
          fi

      - name: Commit Updated Config (Stable)
        if: steps.compare.outputs.TRIGGER_STABLE == '1'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          file_pattern: .github/misc/config.stable.updated.toml
          commit_message: "Update config.stable.updated.toml for new stable patches"

      - name: Commit Updated Config (Dev)
        if: steps.compare.outputs.TRIGGER_PRERELEASE == '1'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          file_pattern: .github/misc/config.dev.updated.toml
          commit_message: "Update config.dev.updated.toml for new dev patches"

      - name: Generate Version Numbers (Stable and Dev)
        id: versions
        if: steps.compare.outputs.TRIGGER_STABLE == '1' || steps.compare.outputs.TRIGGER_PRERELEASE == '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh release list --exclude-drafts -L 100 | awk -F '\t' '{print $3}' | grep -E '^[0-9]+$' | sort -nr | head -n1)
          if [ -z "$TAG" ] || ! [[ "$TAG" =~ ^[0-9]+$ ]]; then TAG=0; fi

          TRIGGER_STABLE=${{ steps.compare.outputs.TRIGGER_STABLE }}
          TRIGGER_PRERELEASE=${{ steps.compare.outputs.TRIGGER_PRERELEASE }}

          NEXT_STABLE=""
          NEXT_DEV=""

          if [ "$TRIGGER_STABLE" = "1" ] && [ "$TRIGGER_PRERELEASE" = "1" ]; then
            NEXT_STABLE=$((TAG + 1))
            NEXT_DEV=$((TAG + 2))
          elif [ "$TRIGGER_STABLE" = "1" ]; then
            NEXT_STABLE=$((TAG + 1))
          elif [ "$TRIGGER_PRERELEASE" = "1" ]; then
            NEXT_DEV=$((TAG + 1))
          fi

          echo "next_stable_ver=${NEXT_STABLE}" >> "$GITHUB_OUTPUT"
          echo "next_dev_ver=${NEXT_DEV}" >> "$GITHUB_OUTPUT"

  build-stable:
    needs: check-patch
    if: needs.check-patch.outputs.trigger_stable == '1'
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (Main)
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          submodules: true

      - name: Setup Java (Zulu 17)
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Notify Telegram (New Stable Patch)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: "@rvbygeo"
          TG_THREAD_ID: "345"
        run: |
          NL=$'\n'
          MSG="*New Patch Detected!*${NL}"
          if [ "${{ needs.check-patch.outputs.sa_new }}" != "${{ needs.check-patch.outputs.sa_old }}" ]; then
            MSG+="${NL}• [Advanced](https://github.com/anddea/revanced-patches/releases/tag/${{ needs.check-patch.outputs.sa_new }}):${NL}Old: \`${{ needs.check-patch.outputs.sa_old }}\` → New: \`${{ needs.check-patch.outputs.sa_new }}\`${NL}"
          fi
          if [ "${{ needs.check-patch.outputs.so_new }}" != "${{ needs.check-patch.outputs.so_old }}" ]; then
            MSG+="${NL}• [Official](https://github.com/ReVanced/revanced-patches/releases/tag/${{ needs.check-patch.outputs.so_new }}):${NL}Old: \`${{ needs.check-patch.outputs.so_old }}\` → New: \`${{ needs.check-patch.outputs.so_new }}\`${NL}"
          fi
          if [ "${{ needs.check-patch.outputs.se_new }}" != "${{ needs.check-patch.outputs.se_old }}" ]; then
            MSG+="${NL}• [Extended](https://github.com/inotia00/revanced-patches/releases/tag/${{ needs.check-patch.outputs.se_new }}):${NL}Old: \`${{ needs.check-patch.outputs.se_old }}\` → New: \`${{ needs.check-patch.outputs.se_new }}\`${NL}"
          fi
          MSG+="${NL}[Triggering new build...](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)${NL}${NL}@rvbygeo"
          MSG=${MSG:0:9450}
          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendMessage"

      - name: Build Modules and APKs (Stable)
        run: |
          rm -rf build
          mkdir -p build
          ./build.sh .github/misc/config.stable.updated.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: $GITHUB_REPOSITORY
          NEXT_VER_CODE: ${{ needs.check-patch.outputs.next_stable_ver }}

      - name: Get Output (Stable)
        id: get_output_stable
        run: |
          DELIM="$(openssl rand -hex 8)"
          echo "BUILD_LOG<<${DELIM}" >> "$GITHUB_OUTPUT"
          cat build.md >> "$GITHUB_OUTPUT"
          echo "${DELIM}" >> "$GITHUB_OUTPUT"
          cp -f build.md build.tmp

      - name: Upload to Release (Stable)
        uses: svenstaro/upload-release-action@v2
        with:
          body: ${{ steps.get_output_stable.outputs.BUILD_LOG }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./build/*
          file_glob: true
          release_name: Build No. ${{ needs.check-patch.outputs.next_stable_ver }}
          tag: ${{ needs.check-patch.outputs.next_stable_ver }}
          overwrite: true

      - name: Update Changelog and Magisk Update JSON (Stable)
        run: |
          git checkout -f update || git switch --discard-changes --orphan update
          cp -f build.tmp build.md
          get_update_json() {
            echo "{
            \"version\": \"$1\",
            \"versionCode\": ${{ needs.check-patch.outputs.next_stable_ver }},
            \"zipUrl\": \"$2\",
            \"changelog\": \"https://raw.githubusercontent.com/$GITHUB_REPOSITORY/update/build.md\"
          }"
          }
          cd build || { echo "build folder not found"; exit 1; }
          for OUTPUT in *magisk*.zip; do
            [ "$OUTPUT" = "*magisk*.zip" ] && continue
            ZIP_S=$(unzip -p "$OUTPUT" module.prop)
            if ! UPDATE_JSON=$(echo "$ZIP_S" | grep updateJson); then continue; fi
            UPDATE_JSON="${UPDATE_JSON##*/}"
            VER=$(echo "$ZIP_S" | grep version=)
            VER="${VER##*=}"
            DLURL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ needs.check-patch.outputs.next_stable_ver }}/${OUTPUT}"
            get_update_json "$VER" "$DLURL" >"../$UPDATE_JSON"
          done
          cd ..
          find . -name "*-update.json" | grep . || : >dummy-update.json

      - name: Commit Updated Build MD and Update JSON Files (Stable)
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: update
          skip_checkout: true
          file_pattern: build.md *-update.json
          commit_message: Bump version ${{ needs.check-patch.outputs.next_stable_ver }}

      - name: Notify Telegram (Stable Build Complete)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: "@rvbygeo"
          TG_THREAD_ID: "262"
        run: |
          cd build || exit 1
          NL=$'\n'
          APKS=""
          MODULES=""
          HAS_MODULES=false
          for OUTPUT in *; do
            DL_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ needs.check-patch.outputs.next_stable_ver }}/${OUTPUT}"
            if [[ $OUTPUT = *.apk ]]; then
              APKS+="${NL}${NL}[${OUTPUT}](${DL_URL})"
            elif [[ $OUTPUT = *.zip ]]; then
              MODULES+="${NL}${NL}[${OUTPUT}](${DL_URL})"
              HAS_MODULES=true
            fi
          done
          MODULES=${MODULES#"$NL"}
          APKS=${APKS#"$NL"}
          BODY="$(sed 's/^\* \*\*/↪ \*\*/g; s/^\* `/↪ \*\*/g; s/`/\*/g; s/^\* /\↪/g; s/\*\*/\*/g; s/###//g; s/^- /↪ /g; /^==/d;' ../build.md)"
          MSG="*Build No. ${{ needs.check-patch.outputs.next_stable_ver }}*${NL}${NL}${BODY}${NL}${NL}"
          if [ "$HAS_MODULES" = true ]; then
            MSG+="*Modules:*${MODULES}${NL}${NL}"
          fi
          MSG+="*APKs:*${APKS}"
          MSG=${MSG:0:9450}
          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendMessage"

  build-dev:
    needs: [check-patch, build-stable]
    if: always() && needs.check-patch.outputs.trigger_prerelease == '1'
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (Main)
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          submodules: true

      - name: Setup Java (Zulu 17)
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Notify Telegram (New Dev Patch)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: "@rvbygeo"
          TG_THREAD_ID: "345"
        run: |
          NL=$'\n'
          MSG="*New Patch Detected!* (Pre-release)${NL}"
          if [ "${{ needs.check-patch.outputs.pa_new }}" != "${{ needs.check-patch.outputs.pa_old }}" ]; then
            MSG+="${NL}• [Advanced](https://github.com/anddea/revanced-patches/releases/tag/${{ needs.check-patch.outputs.pa_new }}):${NL}Old: \`${{ needs.check-patch.outputs.pa_old }}\` → New: \`${{ needs.check-patch.outputs.pa_new }}\`${NL}"
          fi
          if [ "${{ needs.check-patch.outputs.po_new }}" != "${{ needs.check-patch.outputs.po_old }}" ]; then
            MSG+="${NL}• [Official](https://github.com/ReVanced/revanced-patches/releases/tag/${{ needs.check-patch.outputs.po_new }}):${NL}Old: \`${{ needs.check-patch.outputs.po_old }}\` → New: \`${{ needs.check-patch.outputs.po_new }}\`${NL}"
          fi
          if [ "${{ needs.check-patch.outputs.pe_new }}" != "${{ needs.check-patch.outputs.pe_old }}" ]; then
            MSG+="${NL}• [Extended](https://github.com/inotia00/revanced-patches/releases/tag/${{ needs.check-patch.outputs.pe_new }}):${NL}Old: \`${{ needs.check-patch.outputs.pe_old }}\` → New: \`${{ needs.check-patch.outputs.pe_new }}\`${NL}"
          fi
          MSG+="${NL}[Triggering new build...](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)${NL}${NL}@rvbygeo"
          MSG=${MSG:0:9450}
          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendMessage"

      - name: Build Modules and APKs (Dev)
        run: |
          rm -rf build
          mkdir -p build
          ./build.sh .github/misc/config.dev.updated.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: $GITHUB_REPOSITORY
          NEXT_VER_CODE: ${{ needs.check-patch.outputs.next_dev_ver }}

      - name: Get Output (Dev)
        id: get_output_dev
        run: |
          DELIM="$(openssl rand -hex 8)"
          echo "BUILD_LOG<<${DELIM}" >> "$GITHUB_OUTPUT"
          cat build.md >> "$GITHUB_OUTPUT"
          echo "${DELIM}" >> "$GITHUB_OUTPUT"
          cp -f build.md build.tmp

      - name: Upload to Release (Dev)
        uses: svenstaro/upload-release-action@v2
        with:
          body: ${{ steps.get_output_dev.outputs.BUILD_LOG }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./build/*
          file_glob: true
          release_name: Build No. ${{ needs.check-patch.outputs.next_dev_ver }}
          tag: ${{ needs.check-patch.outputs.next_dev_ver }}
          prerelease: true
          overwrite: true

      - name: Update Changelog and Magisk Update JSON (Dev)
        run: |
          git checkout -f update || git switch --discard-changes --orphan update
          cp -f build.tmp build.md
          get_update_json() {
            echo "{
            \"version\": \"$1\",
            \"versionCode\": ${{ needs.check-patch.outputs.next_dev_ver }},
            \"zipUrl\": \"$2\",
            \"changelog\": \"https://raw.githubusercontent.com/$GITHUB_REPOSITORY/update/build.md\"
          }"
          }
          cd build || { echo "build folder not found"; exit 1; }
          for OUTPUT in *magisk*.zip; do
            [ "$OUTPUT" = "*magisk*.zip" ] && continue
            ZIP_S=$(unzip -p "$OUTPUT" module.prop)
            if ! UPDATE_JSON=$(echo "$ZIP_S" | grep updateJson); then continue; fi
            UPDATE_JSON="${UPDATE_JSON##*/}"
            VER=$(echo "$ZIP_S" | grep version=)
            VER="${VER##*=}"
            DLURL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ needs.check-patch.outputs.next_dev_ver }}/${OUTPUT}"
            get_update_json "$VER" "$DLURL" >"../$UPDATE_JSON"
          done
          cd ..
          find . -name "*-update.json" | grep . || : >dummy-update.json
      
      - name: Commit Updated Build MD and Update JSON Files (Dev)
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: update
          skip_checkout: true
          file_pattern: build.md *-update.json
          commit_message: Bump version ${{ needs.check-patch.outputs.next_dev_ver }}

      - name: Notify Telegram (Dev Build Complete)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: "@rvbygeo"
          TG_THREAD_ID: "350"
        run: |
          cd build || exit 1
          NL=$'\n'
          APKS=""
          MODULES=""
          HAS_MODULES=false
          for OUTPUT in *; do
            DL_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ needs.check-patch.outputs.next_dev_ver }}/${OUTPUT}"
            if [[ $OUTPUT = *.apk ]]; then
              APKS+="${NL}${NL}[${OUTPUT}](${DL_URL})"
            elif [[ $OUTPUT = *.zip ]]; then
              MODULES+="${NL}${NL}[${OUTPUT}](${DL_URL})"
              HAS_MODULES=true
            fi
          done
          MODULES=${MODULES#"$NL"}
          APKS=${APKS#"$NL"}
          BODY="$(sed 's/^\* \*\*/↪ \*\*/g; s/^\* `/↪ \*\*/g; s/`/\*/g; s/^\* /\↪/g; s/\*\*/\*/g; s/###//g; s/^- /↪ /g; /^==/d;' ../build.md)"
          MSG="*Build No. ${{ needs.check-patch.outputs.next_dev_ver }}* (Pre-release)${NL}${NL}${BODY}${NL}${NL}"
          if [ "$HAS_MODULES" = true ]; then
            MSG+="*Modules:*${MODULES}${NL}${NL}"
          fi
          MSG+="*APKs:*${APKS}"
          MSG=${MSG:0:9450}
          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendMessage"

  cleanup:
    needs: [check-patch, build-stable, build-dev]
    if: always() && (needs.check-patch.outputs.trigger_prerelease == '1' || needs.check-patch.outputs.trigger_stable == '1')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Delete Older Releases and Workflows
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true
          delete_tags: true
          releases_keep_latest: 20
          delete_workflows: true
          workflows_keep_day: 3
          gh_token: ${{ secrets.GITHUB_TOKEN }}
