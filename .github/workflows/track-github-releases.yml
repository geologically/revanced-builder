name: Track GitHub Releases

on:
  schedule:
    - cron: "20 15 * * *"
  workflow_dispatch:

env:
  TG_CHAT: "@revanced_builder"
  TG_THREAD_ID: "267"

concurrency:
  group: track-updates
  cancel-in-progress: false

jobs:
  track-github-releases:
    name: Track GitHub Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Ensure repos.json exists
        run: |
          set -euo pipefail
          mkdir -p .github/misc
          if [ ! -f .github/misc/repos.json ]; then
            echo "{}" > .github/misc/repos.json
          fi

      - name: Check releases and notify
        id: notify
        if: ${{ secrets.TG_TOKEN != '' }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          NL=$'\n'
          FILE=".github/misc/repos.json"
          UPDATED=false
          TEMP_FILE="$(mktemp)"

          while IFS= read -r repo; do
            if [ -z "$repo" ]; then continue; fi

            LAST_TAG=$(jq -r --arg r "$repo" '.[$r] // empty' "$FILE")
            echo "Checking $repo (last: ${LAST_TAG:-<none>})"

            RESPONSE=$(curl -sf \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/$repo/releases/latest" 2>/dev/null) || {
              echo "No release or error for $repo"
              continue
            }

            NEW_TAG=$(echo "$RESPONSE" | jq -r '.tag_name')
            if [ -z "$NEW_TAG" ] || [ "$NEW_TAG" = "$LAST_TAG" ]; then
              echo "No new release for $repo"
              continue
            fi

            echo "New release for $repo: $NEW_TAG"

            cp "$FILE" "$TEMP_FILE"
            jq --arg r "$repo" --arg t "$NEW_TAG" '.[$r] = $t' "$TEMP_FILE" > "$FILE"
            UPDATED=true

            NAME=$(echo "$RESPONSE" | jq -r '.name // .tag_name')
            URL=$(echo "$RESPONSE" | jq -r '.html_url')
            ESC_NAME=$(echo "$NAME" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g')
            MSG="*New Release Detected!*${NL}${NL}*${repo}*: [${ESC_NAME}](${URL})${NL}${NL}"

            ASSET_COUNT=$(echo "$RESPONSE" | jq -r '.assets | length')
            if [ "$ASSET_COUNT" -gt 0 ]; then
              MSG+="*Assets:*${NL}"
              for i in $(seq 0 $((ASSET_COUNT - 1))); do
                ASSET_NAME=$(echo "$RESPONSE" | jq -r ".assets[$i].name")
                DL_URL=$(echo "$RESPONSE" | jq -r ".assets[$i].browser_download_url")
                ESC_ASSET=$(echo "$ASSET_NAME" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g')
                MSG+="[${ESC_ASSET}](${DL_URL})${NL}${NL}"
              done
            else
              MSG+="No assets attached.${NL}${NL}"
            fi
            MSG+="@revanced\\_builder"

            curl -s -X POST \
              --data-urlencode "chat_id=${TG_CHAT}" \
              --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
              --data-urlencode "parse_mode=Markdown" \
              --data-urlencode "disable_web_page_preview=true" \
              --data-urlencode "text=${MSG:0:9450}" \
              "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" >/dev/null

            sleep 1

          done < <(jq -r 'keys[]' "$FILE")

          if [ "$UPDATED" = true ]; then
            echo "updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit updated repos.json
        if: steps.notify.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/repos.json
          commit_message: "update tracked release versions"

  track-fiorenmas-apks:
    name: Track FiorenMas APK Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: track-github-releases
    if: always()
    steps:
      - name: Checkout (Main)
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Fetch APK Assets (FiorenMas Repo)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p .github/misc
          RESP=$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tags/all" || echo "")
          if [ -z "$RESP" ]; then
            echo "Failed to fetch releases from FiorenMas repo"
            RESP='{"assets":[]}'
          fi

          printf '%s\n' "$RESP" | jq -r '
            .assets // []
            | map(select(.name | endswith(".apk")))
            | map({ name: .name, updated_at: .updated_at, url: .browser_download_url })
          ' > .github/misc/current_apks.json

      - name: Initialize Timestamp File if Missing
        id: init_file
        run: |
          set -euo pipefail
          TIMESTAMP_FILE=".github/misc/apk_timestamps.json"
          if [ ! -f "$TIMESTAMP_FILE" ]; then
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' .github/misc/current_apks.json \
              > "$TIMESTAMP_FILE"
            echo "missing=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Initialized Timestamp File
        if: steps.init_file.outputs.missing == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Initialize timestamp tracking JSON"

      - name: Compare and Detect Changes
        id: compare
        run: |
          set -euo pipefail
          TIMESTAMP_FILE=".github/misc/apk_timestamps.json"
          CURRENT_FILE=".github/misc/current_apks.json"
          LINKS_FILE="/tmp/apk_links.md"

          CHANGED_MARKDOWN=$(jq -nr --argjson current "$(cat "$CURRENT_FILE")" --argjson stored "$(cat "$TIMESTAMP_FILE")" '
            [$current[] | select(.updated_at != ($stored[.name] // ""))] |
            if length == 0 then
              empty
            else
              map(.url |= sub("\\s+$"; "")) |
              map("[\(.name)](\(.url))") |
              join("\n\n")
            end
          ')

          if [ -n "$CHANGED_MARKDOWN" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "$CHANGED_MARKDOWN" > "$LINKS_FILE"

            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' "$CURRENT_FILE" \
              > "$TIMESTAMP_FILE"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "" > "$LINKS_FILE"
          fi

      - name: Commit Updated Timestamps
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Update apk_timestamps.json for new timestamps"

      - name: Notify Telegram (New APK)
        if: steps.compare.outputs.changed == 'true' && secrets.TG_TOKEN != ''
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
        run: |
          set -euo pipefail
          NL=$'\n'
          LINKS_FILE="/tmp/apk_links.md"
      
          if [ ! -s "$LINKS_FILE" ]; then
            echo "ERROR: Links file is unexpectedly empty." >&2
            exit 1
          fi
      
          mapfile -t LINKS < <(grep -v '^$' "$LINKS_FILE")
      
          BASE_MSG_HEADER="*New APK Detected in FiorenMas Repo!*"
          BASE_MSG_FOOTER="$NL$NL@revanced\\_builder"
          MAX_LENGTH=4000  
      
          current_msg="$BASE_MSG_HEADER"
          messages=()
      
          for link in "${LINKS[@]}"; do
            candidate_msg="${current_msg}${NL}${NL}${link}"
            if [ ${#candidate_msg} -le $MAX_LENGTH ]; then
              current_msg="$candidate_msg"
            else
              messages+=("$current_msg$BASE_MSG_FOOTER")
              current_msg="$BASE_MSG_HEADER${NL}${NL}${link}"
            fi
          done
      
          if [ ${#current_msg} -gt ${#BASE_MSG_HEADER} ]; then
            messages+=("$current_msg$BASE_MSG_FOOTER")
          fi
      
          for msg in "${messages[@]}"; do
            curl -s -X POST \
              --data-urlencode "chat_id=${TG_CHAT}" \
              --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
              --data-urlencode "parse_mode=Markdown" \
              --data-urlencode "disable_web_page_preview=true" \
              --data-urlencode "text=${msg:0:9450}" \
              "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" >/dev/null
            sleep 1  
          done
