name: Track GitHub Releases

on:
  schedule:
    - cron: "20 15 * * *"
  workflow_dispatch:

concurrency:
  group: track-updates
  cancel-in-progress: false

jobs:
  track-github-releases:
    name: Track GitHub Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Ensure repos.json exists
        run: |
          set -euo pipefail
          mkdir -p .github/configs
          if [ ! -f .github/configs/repos.json ]; then
            echo "{}" > .github/configs/repos.json
          fi

      - name: Check releases and notify
        id: notify
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
        run: |
          set -euo pipefail
          source .github/scripts/config.sh
          
          NL=$'\n'
          FILE=".github/configs/repos.json"
          UPDATED=false

          retry_curl() {
            local url="$1"
            local attempts=5
            local delay=2
            local response=""

            for i in $(seq 1 $attempts); do
              response=$(curl -sS -w '\n%{http_code}' \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GH_TOKEN" \
                "$url" 2>&1)
              
              local http_code=$(echo "$response" | tail -n1)
              local body=$(echo "$response" | sed '$d')
              
              if [ "$http_code" = "200" ]; then
                echo "$body"
                return 0
              fi
              
              echo "⚠️  Attempt $i failed (HTTP $http_code). Retrying in $delay seconds..." >&2
              sleep $delay
              delay=$((delay * 2))
            done

            echo "" # Return empty on failure
            return 1
          }

          for repo in $(jq -r 'keys[]' "$FILE"); do
            LAST_TAG=$(jq -r --arg r "$repo" '.[$r] // ""' "$FILE")

            echo "Checking $repo (last: ${LAST_TAG:-none})"

            RESPONSE=$(retry_curl "https://api.github.com/repos/$repo/releases/latest")

            # Validate JSON response
            if [ -z "$RESPONSE" ] || ! echo "$RESPONSE" | jq empty 2>/dev/null; then
              echo "⚠️  Invalid or empty response for $repo. Skipping."
              continue
            fi

            NEW_TAG=$(echo "$RESPONSE" | jq -r '.tag_name // ""')
            if [ -z "$NEW_TAG" ] || [ "$NEW_TAG" = "$LAST_TAG" ]; then
              echo "No new release for $repo"
              continue
            fi

            echo "✅ New release for $repo: $NEW_TAG"

            jq --arg r "$repo" --arg t "$NEW_TAG" '.[$r] = $t' "$FILE" > "$FILE.tmp"
            mv "$FILE.tmp" "$FILE"
            UPDATED=true

            RELEASE_NAME=$(echo "$RESPONSE" | jq -r '.name // .tag_name')
            URL=$(echo "$RESPONSE" | jq -r '.html_url')
            ESC_NAME=$(printf "%s" "$RELEASE_NAME" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g')

            MSG="*New Release Detected!*${NL}${NL}*${repo}*: [${ESC_NAME}](${URL})${NL}${NL}"

            ASSETS=$(echo "$RESPONSE" | jq -c '.assets // []')
            if [ "$(echo "$ASSETS" | jq 'length')" -gt 0 ]; then
              MSG+="*Assets:*${NL}"
              
              while IFS= read -r asset; do
                ASSET_NAME=$(echo "$asset" | jq -r '.name')
                DL=$(echo "$asset" | jq -r '.browser_download_url')
                ESC_ASSET=$(printf "%s" "$ASSET_NAME" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g')
                MSG+="[${ESC_ASSET}](${DL})${NL}${NL}"
              done < <(echo "$ASSETS" | jq -c '.[]')
              
            else
              MSG+="No assets attached.${NL}"
            fi

            # Use MAX_MSG_LENGTH from config.sh
            curl -s -X POST \
              --data-urlencode "chat_id=${TG_CHAT}" \
              --data-urlencode "message_thread_id=${TG_THREAD_ID_GITHUB_RELEASES}" \
              --data-urlencode "parse_mode=Markdown" \
              --data-urlencode "disable_web_page_preview=true" \
              --data-urlencode "text=${MSG:0:$MAX_MSG_LENGTH}" \
              "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" >/dev/null

            sleep 1
          done

          echo "updated=$UPDATED" >> "$GITHUB_OUTPUT"

      - name: Commit updated repos.json
        if: steps.notify.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/configs/repos.json
          commit_message: "Update tracked release versions"

  track-fiorenmas-apks:
    name: Track FiorenMas APK Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: track-github-releases
    if: always()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Fetch APK Assets (FiorenMas Repo)
        run: |
          set -euo pipefail
          mkdir -p .github/configs
          
          RESPONSE=$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tags/all")
          
          # Validate response
          if ! echo "$RESPONSE" | jq empty 2>/dev/null; then
            echo "⚠️  Invalid JSON response from API"
            echo '[]' > .github/configs/current_apks.json
            exit 0
          fi
          
          echo "$RESPONSE" | jq -r '
            (.assets // [])
            | map(select(.name | endswith(".apk")))
            | map({ name: .name, updated_at: .updated_at, url: .browser_download_url })
          ' > .github/configs/current_apks.json

      - name: Initialize Timestamp File if Missing
        id: init_file
        run: |
          set -euo pipefail
          FILE=".github/configs/apk_timestamps.json"
          if [ ! -f "$FILE" ]; then
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' \
              .github/configs/current_apks.json > "$FILE"
            echo "missing=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Initialized Timestamp File
        if: steps.init_file.outputs.missing == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/configs/apk_timestamps.json
          commit_message: "Initialize apk_timestamps.json"

      - name: Compare and Detect Changes
        id: compare
        run: |
          set -euo pipefail
          CURRENT=".github/configs/current_apks.json"
          STORED=".github/configs/apk_timestamps.json"

          CHANGES=$(jq -nr \
            --argjson cur "$(cat $CURRENT)" \
            --argjson old "$(cat $STORED)" '
            [$cur[] | select(.updated_at != ($old[.name] // ""))] |
            if length == 0 then empty else
              map("[\(.name)](\(.url))") | join("\n\n")
            end
          ')

          if [ -n "$CHANGES" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "$CHANGES" > /tmp/apk_links.md

            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' \
              "$CURRENT" > "$STORED"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "" > /tmp/apk_links.md
          fi

      - name: Commit Updated Timestamps
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/configs/apk_timestamps.json
          commit_message: "Update apk timestamps"

      - name: Notify Telegram (New APK)
        if: steps.compare.outputs.changed == 'true'
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
        run: |
          set -euo pipefail
          source .github/scripts/config.sh
          
          NL=$'\n'
          
          # Use mapfile/readarray for safe array handling
          mapfile -t LINKS < <(grep -v '^$' /tmp/apk_links.md)

          BASE_HEAD="*New APK Detected in FiorenMas Repo!*"
          MAX=$MAX_MSG_LENGTH

          current="$BASE_HEAD"
          msgs=()

          for L in "${LINKS[@]}"; do
            test="$current$NL$NL$L"
            if (( ${#test} <= MAX )); then
              current="$test"
            else
              msgs+=("$current")
              current="$BASE_HEAD$NL$NL$L"
            fi
          done

          msgs+=("$current")

          for m in "${msgs[@]}"; do
            curl -s -X POST \
              --data-urlencode "chat_id=${TG_CHAT}" \
              --data-urlencode "message_thread_id=${TG_THREAD_ID_GITHUB_RELEASES}" \
              --data-urlencode "parse_mode=Markdown" \
              --data-urlencode "disable_web_page_preview=true" \
              --data-urlencode "text=${m:0:$MAX_MSG_LENGTH}" \
              "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" >/dev/null
            sleep 1
          done
