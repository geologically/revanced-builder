name: Build Manually

on:
  workflow_dispatch:

concurrency:
  group: manual-build
  cancel-in-progress: false

jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java (Zulu 17)
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: true

      - name: Get Next Version Code
        id: next_ver_code
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG=$(gh release list --exclude-drafts -L 100 | awk -F '\t' '{print $3}' | grep -E '^[0-9]+$' | sort -nr | head -n1)
          if [ -z "$TAG" ] || ! [[ "$TAG" =~ ^[0-9]+$ ]]; then TAG=0; fi
          echo "NEXT_VER_CODE=$((TAG + 1))" >> "$GITHUB_OUTPUT"

      - name: Build Modules and APKs
        run: |
          set -euo pipefail
          if [ -f ".github/misc/config.manual.toml" ]; then
            ./build.sh .github/misc/config.manual.toml
          else
            ./build.sh config.toml
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: $GITHUB_REPOSITORY
          NEXT_VER_CODE: ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}

      - name: Get Output
        id: get_output
        run: |
          set -euo pipefail
          DELIM="$(openssl rand -hex 8)"
          echo "BUILD_LOG<<${DELIM}" >> "$GITHUB_OUTPUT"
          cat build.md >> "$GITHUB_OUTPUT"
          echo "${DELIM}" >> "$GITHUB_OUTPUT"
          cp -f build.md build.tmp

      - name: Check Prerelease Status
        id: check_prerelease
        run: |
          set -euo pipefail
          if [ -f ".github/misc/config.manual.toml" ]; then
            CONFIG=".github/misc/config.manual.toml"
          else
            CONFIG="config.toml"
          fi
          
          if grep -Fq 'patches-version = "dev"' "$CONFIG"; then
            echo "IS_PRERELEASE=true" >> "$GITHUB_OUTPUT"
            echo "TG_THREAD_ID=350" >> "$GITHUB_OUTPUT"
            echo "TITLE_SUFFIX= (Pre-release)" >> "$GITHUB_OUTPUT"
            echo "Status: Prerelease (Thread 350)."
          else
            echo "IS_PRERELEASE=false" >> "$GITHUB_OUTPUT"
            echo "TG_THREAD_ID=262" >> "$GITHUB_OUTPUT"
            echo "TITLE_SUFFIX=" >> "$GITHUB_OUTPUT"
            echo "Status: Release (Thread 262)."
          fi

      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          body: ${{ steps.get_output.outputs.BUILD_LOG }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./build/*
          file_glob: true
          release_name: Build No. ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}
          tag: ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}
          overwrite: true
          prerelease: ${{ steps.check_prerelease.outputs.IS_PRERELEASE }}

      - name: Upload ZIPs to Filebin
        id: upload_filebin
        run: |
          set -euo pipefail
          cd build || { echo "build folder not found"; exit 1; }

          BIN_ID="revanced-builder-manual-${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}-${{ github.run_id }}-${{ github.run_attempt }}"
          FILEBIN_URL="https://filebin.net"

          # Bundle APKs into a single ZIP (if any)
          APK_COUNT=$(ls *.apk 2>/dev/null | wc -l)
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "ðŸ“¦ Bundling $APK_COUNT APK(s) into apks-bundle.zip"
            zip -q9 apks-bundle.zip *.apk
          else
            echo "âš ï¸ No APK files found â€” skipping APK bundle."
          fi

          echo "Uploading ZIP files to bin: $BIN_ID"

          # Upload only .zip files
          uploaded_any=false
          for FILE in *.zip; do
            [ -e "$FILE" ] || continue
            if [ -f "$FILE" ]; then
              echo "â†’ Uploading $FILE..."
              if curl --connect-timeout 30 --max-time 300 --fail-with-body --upload-file "$FILE" "$FILEBIN_URL/$BIN_ID/$FILE"; then
                uploaded_any=true
                echo "âœ“ $FILE uploaded"
              else
                echo "âš ï¸ Failed to upload $FILE (continuing...)"
              fi
            fi
          done

          # Lock bin if any upload succeeded
          if [ "$uploaded_any" = true ]; then
            echo "ðŸ”’ Locking bin as read-only..."
            if curl --connect-timeout 10 --max-time 30 --fail-with-body -X PUT "$FILEBIN_URL/$BIN_ID"; then
              echo "âœ… Bin locked successfully."
            else
              echo "âš ï¸ Failed to lock bin (not critical)."
            fi
            echo "UPLOAD_SUCCESS=true" >> "$GITHUB_OUTPUT"
            echo "FILEBIN_LINK=$FILEBIN_URL/$BIN_ID" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ No ZIP files to upload â€” skipping Filebin."
            echo "UPLOAD_SUCCESS=false" >> "$GITHUB_OUTPUT"
            echo "FILEBIN_LINK=" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Changelog and Magisk Update JSON
        id: update_config
        run: |
          set -euo pipefail
          git checkout -f update || git switch --discard-changes --orphan update
          cp -f build.tmp build.md

          get_update_json() {
            echo "{
            \"version\": \"$1\",
            \"versionCode\": ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }},
            \"zipUrl\": \"$2\",
            \"changelog\": \"https://raw.githubusercontent.com/$GITHUB_REPOSITORY/update/build.md\"
          }"
          }

          cd build || { echo "build folder not found"; exit 1; }
          for OUTPUT in *magisk*.zip; do
            [ "$OUTPUT" = "*magisk*.zip" ] && continue
            ZIP_S=$(unzip -p "$OUTPUT" module.prop)
            if ! UPDATE_JSON=$(echo "$ZIP_S" | grep updateJson); then continue; fi
            UPDATE_JSON="${UPDATE_JSON##*/}"
            VER=$(echo "$ZIP_S" | grep version=)
            VER="${VER##*=}"
            DLURL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}/${OUTPUT}"
            get_update_json "$VER" "$DLURL" >"../$UPDATE_JSON"
          done
          cd ..

          find . -name "*-update.json" | grep . || : >dummy-update.json

      - name: Commit Updated Build MD and Update JSON Files
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: update
          skip_checkout: true
          file_pattern: build.md *-update.json
          commit_message: Bump version ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}
       
      - name: Notify Telegram (Build Complete)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_THREAD_ID: ${{ steps.check_prerelease.outputs.TG_THREAD_ID }}
          TITLE_SUFFIX: ${{ steps.check_prerelease.outputs.TITLE_SUFFIX }}
          FILEBIN_LINK: ${{ steps.upload_filebin.outputs.FILEBIN_LINK }}
          FILEBIN_SUCCESS: ${{ steps.upload_filebin.outputs.UPLOAD_SUCCESS }}
        run: |
          set -euo pipefail
          cd build || { echo "build folder not found"; exit 1; }

          TG_CHAT="@revanced_builder"
          
          NL=$'\n'
          APKS=""
          MODULES=""
          HAS_MODULES=false

          for OUTPUT in *; do
            DL_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}/${OUTPUT}"
            if [[ $OUTPUT = *.apk ]]; then
              APKS+="${NL}${NL}[${OUTPUT}](${DL_URL})"
            elif [[ $OUTPUT = *.zip ]]; then
              MODULES+="${NL}${NL}[${OUTPUT}](${DL_URL})"
              HAS_MODULES=true
            fi
          done

          MODULES=${MODULES#"$NL"}
          APKS=${APKS#"$NL"}

          BODY="$(sed 's/^\* \*\*/â†ª \*\*/g; s/^\* `/â†ª \*\*/g; s/`/\*/g; s/^\* /\â†ª/g; s/\*\*/\*/g; s/###//g; s/^- /â†ª /g; /^==/d;' ../build.md)"

          MSG="*Build No. ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}*${TITLE_SUFFIX}${NL}${NL}${BODY}${NL}${NL}"

          # Only add Filebin link if upload succeeded
          if [ "$FILEBIN_SUCCESS" = "true" ]; then
            MSG+="[Filebin Mirror]($FILEBIN_LINK)${NL}${NL}"
          fi
           
          if [ "$HAS_MODULES" = true ]; then
            MSG+="*Modules:*${MODULES}${NL}${NL}"
          fi

          MSG+="*APKs:*${APKS}"
          MSG=${MSG:0:9450}

          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendMessage"

  cleanup:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Delete Older Releases and Workflows
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true
          delete_tags: true
          releases_keep_latest: 100
          delete_workflows: true
          workflows_keep_day: 30
          gh_token: ${{ secrets.GITHUB_TOKEN }}

          
