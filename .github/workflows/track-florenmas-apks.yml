name: Track FiorenMas APK Updates

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

env:
  TG_CHAT: "@rvbygeo"

jobs:
  track:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Fetch Release Assets (APKs only)
        id: fetch_assets
        run: |
          RESPONSE=$(curl -s "https://api.github.com/repos/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tags/all")
          # Check if API returned valid JSON
          if ! echo "$RESPONSE" | jq empty >/dev/null 2>&1; then
            echo "API returned invalid JSON. Exiting safely."
            echo "current_data=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          APKS=$(echo "$RESPONSE" | jq -r '
            .assets // []
            | map(select(.name | endswith(".apk")))
            | map({ name: .name, updated_at: .updated_at, url: .browser_download_url })
          ')
          echo "current_data<<EOF" >> "$GITHUB_OUTPUT"
          echo "$APKS" | jq -s 'add // []'
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Initialize Timestamp File
        run: |
          TIMESTAMP_FILE=".github/misc/apk_timestamps.json"
          mkdir -p "$(dirname "$TIMESTAMP_FILE")"
          if [ ! -s "$TIMESTAMP_FILE" ]; then
            echo "{}" > "$TIMESTAMP_FILE"
          else
            # Repair if invalid
            if ! jq empty "$TIMESTAMP_FILE" >/dev/null 2>&1; then
              echo "{}" > "$TIMESTAMP_FILE"
            fi
          fi

      - name: Detect Changed APKs
        id: detect
        run: |
          TIMESTAMP_FILE=".github/misc/apk_timestamps.json"
          STORED_JSON=$(cat "$TIMESTAMP_FILE")
          CURRENT_JSON=${{ steps.fetch_assets.outputs.current_data }}

          # Validate both are JSON
          if ! echo "$STORED_JSON" | jq empty >/dev/null 2>&1; then
            echo "Stored JSON invalid. Skipping."
            exit 0
          fi
          if ! echo "$CURRENT_JSON" | jq empty >/dev/null 2>&1; then
            echo "Current JSON invalid. Skipping."
            exit 0
          fi

          CHANGED_LIST=$(jq -n \
            --argjson stored "$STORED_JSON" \
            --argjson current "$CURRENT_JSON" \
            '
            $current
            | map(select(.updated_at != ($stored[.name] // "")))
            | map(.name)
            ')

          if [ "$(echo "$CHANGED_LIST" | jq 'length')" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"

            LINKS=""
            NL=$'\n'
            for apk in $(echo "$CHANGED_LIST" | jq -r '.[]'); do
              url=$(echo "$CURRENT_JSON" | jq -r "map(select(.name == \"$apk\")) | .[0].url // \"\"")
              if [ -n "$url" ]; then
                LINKS+="${NL}${NL}[${apk}](${url})"
              fi
            done
            echo "download_links=${LINKS}" >> "$GITHUB_OUTPUT"

            # Update stored timestamps
            jq -n \
              --argjson assets "$CURRENT_JSON" \
              'reduce $assets[] as $a ({}; .[$a.name] = $a.updated_at)' \
              > "$TIMESTAMP_FILE"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Updated Timestamps
        if: steps.detect.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Update FiorenMas APK timestamps — new version(s) detected"

      - name: Notify Telegram – New APKs Available
        if: steps.detect.outputs.changed == 'true'
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
        run: |
          NL=$'\n'
          MSG="*New APKs Detected in FiorenMas Repo!*${NL}${NL}*APKs:*${{ steps.detect.outputs.download_links }}"
          MSG=${MSG:0:9450}
          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${{ env.TG_CHAT }}" \
            "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage"
