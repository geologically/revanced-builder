name: Track FiorenMas APK Updates

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

env:
  TG_CHAT: "@rvbygeo"

jobs:
  track:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      # ==============================
      # 1. FETCH APK LIST → SAVE TO FILE
      # ==============================
      - name: Fetch APK Assets from FiorenMas Repo
        run: |
          mkdir -p .github/misc
          curl -s "https://api.github.com/repos/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tags/all" \
            | jq -r '
              .assets // []
              | map(select(.name | endswith(".apk")))
              | map({ name: .name, updated_at: .updated_at, url: .browser_download_url })
              ' \
            > .github/misc/current_apks.json

      # ==============================
      # 2. INITIALIZE apk_timestamps.json IF MISSING
      # ==============================
      - name: Initialize Timestamp File if Missing
        id: init_file
        run: |
          TIMESTAMP_FILE=".github/misc/apk_timestamps.json"
          if [ ! -f "$TIMESTAMP_FILE" ]; then
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' .github/misc/current_apks.json \
              > "$TIMESTAMP_FILE"
            echo "missing=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Initialized Timestamp File
        if: steps.init_file.outputs.missing == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Initialize FiorenMas APK timestamp tracking"

      # ==============================
      # 3. COMPARE & DETECT CHANGES → SAVE LINKS TO FILE
      # ==============================
      - name: Compare and Detect Changes
        id: compare
        run: |
          TIMESTAMP_FILE=".github/misc/apk_timestamps.json"
          CURRENT_FILE=".github/misc/current_apks.json"
          LINKS_FILE="/tmp/apk_links.md"

          # Find changed APKs
          CHANGED_LIST=$(jq -s '
            .[0] as $stored |
            .[1][] as $apk |
            select($apk.updated_at != ($stored[$apk.name] // ""))
            | $apk.name
          ' "$TIMESTAMP_FILE" "$CURRENT_FILE")

          if [ -n "$(echo "$CHANGED_LIST" | jq -r 'select(length > 0)')" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"

            # Build clean markdown list
            echo "" > "$LINKS_FILE"
            echo "$CHANGED_LIST" | jq -r '.[]' | while IFS= read -r apk; do
              url=$(jq -r "map(select(.name == \"$apk\")) | .[0].url" "$CURRENT_FILE")
              echo "• [${apk}](${url})" >> "$LINKS_FILE"
            done

            # Update timestamps
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' "$CURRENT_FILE" \
              > "$TIMESTAMP_FILE"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "" > "$LINKS_FILE"
          fi

      # ==============================
      # 4. COMMIT & NOTIFY
      # ==============================
      - name: Commit Updated Timestamps
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Update FiorenMas APK timestamps — new version(s) detected"

      - name: Notify Telegram – New APKs Available
        if: steps.compare.outputs.changed == 'true'
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
        run: |
          LINKS=$(cat /tmp/apk_links.md)
          MSG="*New APKs Detected in FiorenMas Repo!*${NL}${NL}*APKs:*${NL}${LINKS}"
          MSG=${MSG:0:9450}
          curl -X POST \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "chat_id=${{ env.TG_CHAT }}" \
            "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage"
